---
title: ember-flexberry-gis
keywords: ember
sidebar: ember-flexberry-gis_sidebar
toc: true
permalink: ru/efg_landing_page.html
lang: ru
published: true
---

## Информация о продукте

[ember-flexberry-gis](https://github.com/Flexberry/ember-flexberry-gis) представляет из себя [ember-аддон](https://ember-cli.com/extending/#developing-addons-and-blueprints), который может опционально устанавливаться в любое [ember-flexberry](https://github.com/Flexberry/ember-flexberry) приложение, добавляя к нему возможность размещать на настраиваемой интерактивной карте, данные, имеющие географичекую привязку.

Пример готовой интерактивной карты, интегрированной в ember-flexbery приложение выглядит следующим образом:

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/map-and-layers-example.png)

Демонстрационное приложение, включающее в себя несколько примеров таких карт располагается по адресу [flexberry.github.io/ember-flexberry-gis](http://flexberry.github.io/ember-flexberry-gis/)

## Состав продукта

Основные элементы, из которых состоит аддон ember-flexberry-gis:

* ember-flexberry-data модель для интерактивной карты (либо нескольких карт), а также модели для слоев наполняющих карту;
* ember-flexberry-data сериалайзеры к этим моделям;
* Базовые классы роутов и контроллеров для списковой формы и формы просмотра/редактирования интерактивной карты;
* Форма поиска карт и слоев, которая может опционально включаться в приложение при наличии в нем большого числа карт и слоев для них;
* ember-компоненты интерактивной карты, её слоев, а также её инструментов;

## Модель интерактивной карты и её слоев

В виде UML-диаграммы модель данных интерактивной карты и её слоев выглядит следующим образом:

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/map-and-layers-diagram.png)

Карта представляет из себя класс со следующим набором полей:

Наименование поля          |Тип поля          |Описание          
:--------------------------|:-----------------|:-----------------
`Name`| `String` | Наименование карты 
`Description`| `String` | Описание карты 
`KeyWords`| `String` | Клчевые слова разделенные запятыми (используются формой поиска, при её наличии) 
`AnyText`| `String` | Вычислимое поле, включающее наименование карты её описание и ключевые слова (используются формой поиска, при её наличии, для полнотекстового поиска) 
`Lat`| `Double` | Широта центра карты 
`Lng`| `Double` | Долгота центра карты 
`Zoom`| `Double` | Значение "приближения" карты в диапазоне от 0 до 18 
`Public`| `Bool` | Флаг: является ли карта общедуступной
`Scale`| `Int` | Целочисенное значение мастштаба/точности, например, если данные карты представлены в масштабе 1:10000, то значение этого поля будет 10000
`CoordinateReferenceSystem`| `String` | Сериализованное JSON-описание системы координат карты (по умолчанию `{"code":"EPSG:3857"}`)
`BoundingBox`| `Geography` | Опциональный прямоугольник ограничивающий границы карты (используется формой поиска, при её наличии, для поиска по пересечению с заданными границами, а также одним из инструментов карты для пиближения к её границам). Тип `Geography` поддерживается только специализированными сервисами данных, в которых реализована поддержка географических/геометрических типов данных: для MSSQL это [GisMSSQLDataService](https://github.com/Flexberry/NewPlatform.Flexberry.ORM.GisMSSQLDataService), а для PostgreSQL это [GisPostgresDataService](https://github.com/Flexberry/NewPlatform.Flexberry.ORM.GisPostgresDataService), именно один из этих сервисов данных должен быть установлен в серверной части приложения и указан в конфиграционном файле приложения в качестве основного, если в приложении планируется использовать ember-flexberry-gis

Слой карты представляет из себя класс являющийся детейлом карты, со следующим набором полей и с иерархической ссылкой на самого себя:

Наименование поля          |Тип поля          |Описание          
:--------------------------|:-----------------|:-----------------
`Name`| `String` | Наименование слоя 
`Description`| `String` | Описание слоя 
`KeyWords`| `String` | Клчевые слова разделенные запятыми (используются формой поиска, при её наличии) 
`AnyText`| `String` | Вычислимое поле, включающее наименование слоя, его описание и ключевые слова (используются формой поиска, при её наличии, для полнотекстового поиска) 
`Index`| `Int` | Позиция слоя в иерархии слоев карты (слои с меньшим индексом располагаются в иерархии слоев ближе к корню иерархии и "ниже") 
`Visibility`| `Bool` | Флаг: показывает виимость слоя на карте (`true` - слой видим на карте, `false` - невидим) 
`Type`| `String` | Тип слоя (наименования одного из типов слоев, реализованных либо в ember-flexberry-gis, либо в аддонах дополняющих ember-flexberry-gis, либо с прикладной стороны, например `group`, `tile`, `wfs`, `wms-wfs`, `wms-signle-tile`, `kml`, `geojson`, `osm`,  и .т.п.)
`Settings`| `String` | Сериализованное JSON-описание слоя вида `{"opacity":1,"bounds":[[-90,-180],[90,180]],"wgs84bbox":[[],[]],"bbox":[[],[]],"displaySettings":{"dateFormat":"DD.MM.YYYY","featuresPropertiesSettings":{"displayPropertyIsCallback":false,"displayProperty":null,"excludedProperties":[],"localizedProperties":{"ru":{},"en":{}}}},"url":"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}`, здесь настройки `opacity`, `bounds`, `wgs84bbox`, `bbox`, `displaySettings`, являются общими для большинства типов слоев, остальные же настройки варьируются в зависимости от используемого типа слоя, здесь приведен пример настроек для слоя типа `tile`, и единственной специфичной для него настройкой явяется `"url":"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"`, у слоев других типов таких настроек может быть больше
`Scale`| `Int` | Целочисенное значение мастштаба/точности, например, если данные слоя представлены в масштабе 1:10000, то значение этого поля будет 10000
`CoordinateReferenceSystem`| `String` | Сериализованное JSON-описание системы координат слоя (например `{"code":"EPSG:3857"}`)
`BoundingBox`| `Geography` | Опциональный прямоугольник ограничивающий границы слоя (используется формой поиска, при её наличии, для поиска по пересечению с заданными границами, а также одним из инструментов карты для пиближения к границам слоя). Тип `Geography` поддерживается только специализированными сервисами данных, в которых реализована поддержка географических/геометрических типов данных: для MSSQL это [GisMSSQLDataService](https://github.com/Flexberry/NewPlatform.Flexberry.ORM.GisMSSQLDataService), а для PostgreSQL это [GisPostgresDataService](https://github.com/Flexberry/NewPlatform.Flexberry.ORM.GisPostgresDataService), именно один из этих сервисов данных должен быть установлен в серверной части приложения и указан в конфиграционном файле приложения в качестве основного, если в приложении планируется использовать ember-flexberry-gis

## Поддерживаемые типы слоев карты

### Слои, представленные географически привязанными растровыми изображениями

#### tile

##### Спецификация

Название тайловый слой (от англ. tile - плитка) обусловлено тем, что получаемое такими слоями изображение некоторой карты составляется из набора заранее подготовленных картинок фиксированного размера т.н. тайлов, которые размещаются на плотной сетке рядом друг с другом (как плитка в ванной, только без зазоров).

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/tiles-map.png)

Тайлы подготавливаются таким образом, что при максимальном масштабе вся карта покрывается одним единственным тайлом, который изображает всю площадь карты, но делает это наименее детализировано, как бы "с высоты птичьего полёта".
При минимальном же масштабе карта покрывается достаточно большим количеством тайлов, каждый из которых максимально детализировано изображает соответствующий ему участок карты.
Множество доступных масштабов карты от максимального до минимального равномерно разбивается на конечное число, каждому из которых ставится в соответствие целочисенное обозначение, это так называемый зум (от англ. zoom level - уровень увеличения/уровень масштабирования), который принимает значение 0 для максимального масштаба, и некоторое n для минимального, как правило n = 18, но может быть как меньше так и больше. 

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/tiles-pyramid.png)

Любой тайловый слой запрашивает подготовленные таким образом изображения у специализированных тайловых сервисов, сообщая им зум и координаты изображений, соответствующих просматриваемой области карты. 
Однако т.к. для любого значения зума сетка состоит из конечного числа тайлов, а именно 2^(zoom*2) (т.е. 1, 4, 16, 64, ...), то географические координаты просматриваемой области карты, перед обращением к сервису, преобразуются в целочисленные координаты тайловой сетки для указанного зума.
И вот по способу "маркировки" тайлов этими целочисленными координатами, и способу преобразования географических координат в целочисленные координаты сетки, тайловые сервисы делятся на два типа:

* TMS (Tile Map Service) - разновидность тайловых сервисов, реализующих [спецификацию TMS](http://wiki.osgeo.org/wiki/Tile_Map_Service_Specification), разработанную организацией [The Open Source Geospatial Foundation](https://www.osgeo.org/);
* И так называемые Slippy map - разновидность тайловых сервисов в свое время разработанная и популяризованная сообществом Open Street Map, а затем перенятая Google-картами, и прочими подобными сервисами, также сделавшими свой вклад в популяризацию этой разновидности;

Вторые более популярны, но никаких преимуществ перед использованием TMS они не дают, так же как TMS не дают никаких преимуществ перед Slippy map.
Как уже было сказано основная раница в том как тайлы "маркируются" целыми числами и как при обращнии к сервису нужно преобразовывать географические координаты в целочисленный координаты сетки.

В сервисах TMS координатные оси сетки направлены традиционным образом, а координаты начала отсчёта тайловой сетки (minx, miny):

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/tile-map-service-tiles-grid.png)

В Slippy map сервисах ось Y инвертирована, а координаты начала отсчёта тайловой сетки (minx, maxy):

![](/images/pages/products/flexberry-gis/addons/ember-flexberry-gis/slippy-map-tiles-grid.png)

Для общего понимания разницы этого достаточно, формулы приведения координат здесь рассматривать не будем.

В обоих вариантах сервисов каждый тайл однозначно идентифицируется URL-ом, по которому будет осуществляться запрос на получение изображения.
И в общем случае этот URL-имеет вид `http://{s}.somedomain.com/{z}/{x}/{y}.png` где `{s}` это имя одного из доменов верхнего уровня, этот параметр опционален и при его наличии позволяет клиенту равномерно нагружать запросами все предоставляемые сервисом мощности, `{z}`, `{x}`, `{y}` соответственно зум и координаты запрашиваемого изображения в тайловой сетке, а в конце указан желаемый формат результирующего изображения, и если сервис поддерживает несколько форматов, то можно указывать любой из них.

##### Ember-компонент слоя и его свойства

Ember-компонент реализующий работу с тайловыми слоями располагается по пути [`ember-flexberry-gis/addon/components/layers/tile-layer`](https://github.com/Flexberry/ember-flexberry-gis/blob/develop/addon/components/layers/tile-layer.js) и поддерживает следующий набор свойств, которые соответствуют одноименным с ними настройкам в объекте `settings` в модели слоя:

Наименование свойства          |Тип свойства          |Описание          
:--------------------------|:-----------------|:-----------------
`url`| `String` | Шаблон URL-а, для осуществления запросов на получение тайлов

##### Примеры использования

* Open Street Map
* Google